unit dansguardian;

{$MODE DELPHI}
{$LONGSTRINGS ON}

interface

uses
    Classes, SysUtils,variants,strutils, Process,logs,unix,RegExpr in 'RegExpr.pas',zsystem,kav4proxy,clamav,postfix_class,IniFiles,
    squid in '/home/dtouzeau/developpement/artica-postfix/bin/src/artica-install/squid.pas';

type LDAP=record
      admin:string;
      password:string;
      suffix:string;
      servername:string;
      Port:string;
  end;

  type
  tdansguardian=class


private
     LOGS:Tlogs;
     SYS:TSystem;
     artica_path:string;
     kav4proxy:tkav4proxy;
     clamav:Tclamav;
     cicap_mem_pid:string;
     dansguardian_mem_pid:string;
     username:string;
     postfix:tpostfix;
     SQUIDEnable:integer;
     TAIL_STARTUP:string;

     function GET_VALUE_DATA(conf_path:string;key:string):string;
     function CheckUserButton():boolean;
     function DANSGUARDIAN_TAIL_PID():string;
public
    DansGuardianEnabled:integer;
    kavicapserverEnabled:integer;
    DansGuardianEnableUserFrontEnd:integer;
    CicapEnabled:integer;
    procedure   Free;
    constructor Create(const zSYS:Tsystem);
    function    INITD_PATH():string;
    function    BIN_PATH():string;
    FUNCTION    DANSGUARDIAN_PID():string;
    procedure   DANSGUARDIAN_STOP();
    procedure   DANSGUARDIAN_START(nottroubleshoot:boolean=false);
    procedure   DANSGUARDIAN_RELOAD();
    function    DANSGUARDIAN_STATUS():string;
    function    DANSGUARDIAN_CONFIG_VALUE(key:string):string;
    procedure   DANSGUARDIAN_CONFIG_VALUE_SET(key:string;value:string);
    function    DANSGUARDIAN_VERSION():string;
    function    DANSGUARDIAN_STATS():string;
    procedure   DANSGUARDIAN_TAIL_START();
    function    DANSGUARDIAN_TAIL_STATUS():string;
    procedure   DANSGUARDIAN_TAIL_STOP();
    procedure   DANSGUARDIAN_TROUBLESHOT();
    function    transparent_image_path():string;
    function    CONF_PATH():string;
    procedure   verify_content_scanners();
    function    filtergroupslist_path():string;
    procedure   VERIFY_PARENT_PROXY();
    function    DANSGUARDIAN_DELETE_VALUE(key:string):string;
    function    DANSGUARDIAN_BIN_VERSION(version:string):int64;
    procedure   DANSGUARDIAN_TEMPLATE();
    procedure   REMOVE();

    function    C_ICAP_BIN_PATH():string;
    function    C_ICAP_CONF_PATH():string;
    procedure   C_ICAP_VALUE_SET(key:string;value:string);
    FUNCTION    C_ICAP_PID():string;
    function    C_ICAP_STATUS():string;
    procedure   C_ICAP_START();
    procedure   C_ICAP_STOP();
    procedure   C_ICAP_CONFIGURE();
    procedure   C_ICAP_RELOAD();
END;

implementation

constructor tdansguardian.Create(const zSYS:Tsystem);
begin
       forcedirectories('/etc/artica-postfix');
       LOGS:=tlogs.Create();
       SYS:=zSYS;
       kav4proxy:=tkav4proxy.Create(zSYS);
       clamav:=tclamav.Create;
       username:='squid';
       if fileExists(clamav.CLAMD_BIN_PATH()) then begin
          username:=clamav.CLAMD_GETINFO('User');
       end;

       DansGuardianEnableUserFrontEnd:=1;

       kavicapserverEnabled:=0;
       CicapEnabled:=0;
       TAIL_STARTUP:=SYS.LOCATE_PHP5_BIN()+' /usr/share/artica-postfix/exec.dansguardian-tail.php';
       if not TryStrToInt(SYS.GET_INFO('DansGuardianEnabled'),DansGuardianEnabled) then DansGuardianEnabled:=0;
       if not TryStrToInt(SYS.GET_INFO('kavicapserverEnabled'),kavicapserverEnabled) then kavicapserverEnabled:=0;
       if not TryStrToInt(SYS.GET_INFO('CicapEnabled'),CicapEnabled) then CicapEnabled:=0;
       if not TryStrToInt(SYS.GET_INFO('DansGuardianEnableUserFrontEnd'),DansGuardianEnableUserFrontEnd) then DansGuardianEnableUserFrontEnd:=1;
       if not TryStrToInt(SYS.GET_INFO('SQUIDEnable'),SQUIDEnable) then SQUIDEnable:=1;

       if SQUIDEnable=0 then begin
          DansGuardianEnabled:=0;
          CicapEnabled:=0;
       end;

       if not DirectoryExists('/usr/share/artica-postfix') then begin
              artica_path:=ParamStr(0);
              artica_path:=ExtractFilePath(artica_path);
              artica_path:=AnsiReplaceText(artica_path,'/bin/','');

      end else begin
          artica_path:='/usr/share/artica-postfix';
      end;
end;
//##############################################################################
procedure tdansguardian.free();
begin
    logs.Free;
    clamav.free;
    
end;
//##############################################################################
function tdansguardian.INITD_PATH():string;
begin
   if FileExists('/etc/init.d/dansguardian') then exit('/etc/init.d/dansguardian');
end;
//##############################################################################
function tdansguardian.BIN_PATH():string;
begin
    exit(SYS.LOCATE_DANSGUARDIAN_BIN_PATH());
end;
//##############################################################################
function tdansguardian.CONF_PATH():string;
begin
if FileExists('/etc/dansguardian/dansguardian.conf') then exit('/etc/dansguardian/dansguardian.conf');
exit('/etc/dansguardian/dansguardian.conf');
end;
//##############################################################################
function tdansguardian.C_ICAP_BIN_PATH():string;
begin
if FileExists('/usr/sbin/c-icap') then exit('/usr/sbin/c-icap');
if FileExists('/usr/bin/c-icap') then exit('/usr/bin/c-icap');
end;
//##############################################################################
function tdansguardian.C_ICAP_CONF_PATH():string;
begin
if FileExists('/etc/c-icap/c-icap.conf') then exit('/etc/c-icap/c-icap.conf');
if FileExists('/etc/c-icap.conf') then exit('/etc/c-icap.conf');
end;
//##############################################################################

function tdansguardian.filtergroupslist_path():string;
begin
result:=DANSGUARDIAN_CONFIG_VALUE('filtergroupslist');
end;
//##############################################################################
procedure tdansguardian.verify_content_scanners();
var
   icapuri:string;
   l:TstringList;
   socketpath:string;
begin
   forceDirectories('/etc/dansguardian/contentscanners');
   
   l:=TstringList.Create;
   l.Add('# ICAP URL');
   l.Add('# Use hostname rather than IP address');
   
   if FileExists(C_ICAP_BIN_PATH()) then begin
       if FileExists(clamav.CLAMSCAN_BIN_PATH()) then begin
          icapuri:='localhost:1351';
          logs.Debuglogs('tdansguardian.verify_content_scanners()  c-icap and run on '+icapuri);
          l.Add('plugname = ''icapscan''');
          l.Add('');
          l.Add('# Always specify the port');
          l.Add('#');
          l.Add('icapurl = ''icap://'+icapuri+'/srv_clamav''');
          l.Add('icapsocket = ''localhost:1351''');
          l.Add('');
          l.Add('exceptionvirusmimetypelist = ''/etc/dansguardian/lists/contentscanners/exceptionvirusmimetypelist''');
          l.Add('exceptionvirusextensionlist = ''/etc/dansguardian/lists/contentscanners/exceptionvirusextensionlist''');
          l.Add('exceptionvirussitelist = ''/etc/dansguardian/lists/contentscanners/exceptionvirussitelist''');
          l.Add('exceptionvirusurllist = ''/etc/dansguardian/lists/contentscanners/exceptionvirusurllist''');
          l.Add('');
          logs.Debuglogs('tdansguardian.verify_content_scanners()  Saving icap /etc/dansguardian/contentscanners/icapscan.conf '+icapuri);
       end;
   end;

   logs.WriteToFile(l.Text,'/etc/dansguardian/contentscanners/icapscan.conf');

   l.Clear;
   l.Add('plugname = ''clamav''');
   l.Add('scanbuffmethod = ''file''');
   l.Add('maxfiles = 15000');
   l.Add('maxreclevel = 10');
   l.Add('maxscansize = 100000');
   l.Add('exceptionvirusmimetypelist = ''/etc/dansguardian/lists/contentscanners/exceptionvirusmimetypelist''');
   l.Add('exceptionvirusextensionlist = ''/etc/dansguardian/lists/contentscanners/exceptionvirusextensionlist''');
   l.Add('exceptionvirussitelist = ''/etc/dansguardian/lists/contentscanners/exceptionvirussitelist''');
   l.Add('exceptionvirusurllist = ''/etc/dansguardian/lists/contentscanners/exceptionvirusurllist''');
   logs.Debuglogs('tdansguardian.verify_content_scanners()  Saving clamav /etc/dansguardian/contentscanners/clamav.conf ');
   logs.WriteToFile(l.Text,'/etc/dansguardian/contentscanners/clamav.conf');





   socketpath:=clamav.CLAMD_GETINFO('LocalSocket');
   logs.Debuglogs('Starting......: DansGuardian Clamav socket path:'+ socketpath);
   if length(socketpath)>0 then begin
      l.Clear;
      l.Add('plugname = ''clamdscan''');
      l.Add('clamdudsfile = '''+socketpath+'''');
      l.Add('exceptionvirusmimetypelist = ''/etc/dansguardian/lists/contentscanners/exceptionvirusmimetypelist''');
      l.Add('exceptionvirusextensionlist = ''/etc/dansguardian/lists/contentscanners/exceptionvirusextensionlist''');
      l.Add('exceptionvirussitelist = ''/etc/dansguardian/lists/contentscanners/exceptionvirussitelist''');
      l.Add('exceptionvirusurllist = ''/etc/dansguardian/lists/contentscanners/exceptionvirusurllist''');
      logs.Debuglogs('tdansguardian.verify_content_scanners()  Saving clamav /etc/dansguardian/contentscanners/clamdscan.conf ');
      logs.WriteToFile(l.Text,'/etc/dansguardian/contentscanners/clamdscan.conf');
   end;


  l.free;
   

end;
//##############################################################################
function tdansguardian.DANSGUARDIAN_VERSION():string;
var
   RegExpr        :TRegExpr;
   F              :TstringList;
   T              :string;
   i              :integer;
begin
   result:='';
   if not FileExists(BIN_PATH()) then begin
      logs.Debuglogs('DANSGUARDIAN_VERSION -> unable to stat dansguardian');
      exit;
   end;
   
   result:=SYS.GET_CACHE_VERSION('APP_DANSGUARDIAN');
   if length(result)>0 then exit;
   
   t:=logs.FILE_TEMP();
   fpsystem(BIN_PATH()+' -v >'+t+' 2>&1');
   if not FileExists(t) then exit;
   f:=TstringList.Create;
   f.LoadFromFile(t);
   RegExpr:=TRegExpr.Create;
   RegExpr.Expression:='DansGuardian\s+([0-9\.A-Za-z]+)';
   For i:=0 to f.Count-1 do begin

   if RegExpr.Exec(f.Strings[i]) then begin
      result:=RegExpr.Match[1];
      break;
   end;
   end;
   SYS.SET_CACHE_VERSION('APP_DANSGUARDIAN',result);
   RegExpr.Free;
   f.free;
end;
//#############################################################################
FUNCTION tdansguardian.DANSGUARDIAN_PID():string;
var
  RegExpr:TRegExpr;
  i:integer;
  tmp:string;
begin
  if length(dansguardian_mem_pid)>0 then exit(dansguardian_mem_pid);
  tmp:=logs.FILE_TEMP();
  if FileExists(BIN_PATH()) then begin
     tmp:=SYS.ExecPipe(BIN_PATH()+' -s');
  end else begin
      exit;
  end;

  RegExpr:=TRegExpr.Create;
  RegExpr.expression:='([0-9]+)';
  if RegExpr.Exec(tmp) then begin
       result:=RegExpr.Match[1];
  end else begin
       logs.Debuglogs(BIN_PATH()+' -s return null "'+tmp+'"');
       result:=SYS.PIDOF(BIN_PATH());
  end;
 dansguardian_mem_pid:=result;
 RegExpr.Free;


end;

//##############################################################################
FUNCTION tdansguardian.C_ICAP_PID():string;
var PID,PID2:string;
begin

 if length(cicap_mem_pid)>0 then exit(cicap_mem_pid);


 if not FileExists('/var/run/c-icap/c-icap.pid') then begin
    result:=SYS.PidByProcessPath(C_ICAP_BIN_PATH());
    cicap_mem_pid:=result;
    exit;
 end;
 PID:=SYS.GET_PID_FROM_PATH('/var/run/c-icap/c-icap.pid');
 
 if (PID='0') OR (length(PID)=0) then begin
    result:=SYS.PidByProcessPath(C_ICAP_BIN_PATH());
    cicap_mem_pid:=result;
    exit;
 end;
 
 PID2:=SYS.PidByProcessPath(C_ICAP_BIN_PATH());
 if SYS.PROCESS_EXIST(PID2) and not SYS.PROCESS_EXIST(PID) then begin
    result:=PID2;
    cicap_mem_pid:=PID2;
    exit;
 end;
 
 result:=PID;
 cicap_mem_pid:=PID;
 

end;
//##############################################################################
function tdansguardian.transparent_image_path():string;
begin
if Fileexists('/usr/share/dansguardian/transparent1x1.gif') then exit('/usr/share/dansguardian/transparent1x1.gif');

end;

//##############################################################################
procedure tdansguardian.REMOVE();
begin
writeln('Uninstall Dansguardian');
   DANSGUARDIAN_TAIL_STOP();
   DANSGUARDIAN_STOP();
   fpsystem('/usr/share/artica-postfix/bin/setup-ubuntu --remove "dansguardian"');
   fpsystem(SYS.LOCATE_PHP5_BIN()+' /usr/share/artica-postfix/exec.dansguardian.compile.php --clean-db');
   if FIleExists(INITD_PATH()) then logs.DeleteFile(INITD_PATH());
   if FIleExists(BIN_PATH()) then logs.DeleteFile(BIN_PATH());
   logs.DeleteFile('/etc/artica-postfix/versions.cache');
   logs.OutputCmd('/usr/share/artica-postfix/bin/artica-install --write-versions');
   logs.OutputCmd('/usr/share/artica-postfix/bin/process1 --force');
   fpsystem(SYS.LOCATE_PHP5_BIN()+' /usr/share/artica-postfix/exec.squid.php --reconfigure');
   writeln('Uninstall Dansguardian DONE');
   end;
//##############################################################################



procedure tdansguardian.DANSGUARDIAN_RELOAD();
var
   pid:string;

begin

if not FileExists(BIN_PATH()) then begin
   logs.Debuglogs('Starting......: DansGuardian is not installed');
   exit;
end;

if DansGuardianEnabled=0 then begin
     logs.Debuglogs('Starting......: DansGuardian is disabled, aborting');
     DANSGUARDIAN_TAIL_STOP();
     exit;
end;

  pid:=DANSGUARDIAN_PID();
  fpsystem(SYS.LOCATE_PHP5_BIN()+' /usr/share/artica-postfix/exec.dansguardian.compile.php');

if SYS.PROCESS_EXIST(pid) then begin
     logs.Debuglogs('Starting......: DansGuardian reload dansgardian with PID '+ pid);
     verify_content_scanners();
     VERIFY_PARENT_PROXY();
     DANSGUARDIAN_TEMPLATE();
     logs.Syslogs('Starting......: DansGuardian will be reloaded with username "'+username+'"');
     DANSGUARDIAN_CONFIG_VALUE_SET('daemonuser',username);
     DANSGUARDIAN_CONFIG_VALUE_SET('daemongroup',username);
     logs.OutputCmd(BIN_PATH() + ' -r');
     DANSGUARDIAN_TAIL_START();
     exit;
end;


DANSGUARDIAN_START();
end;

//##############################################################################
procedure tdansguardian.DANSGUARDIAN_START(nottroubleshoot:boolean);
var
   count:integer;
   pid:string;
   FileTemp:string;
   verb:string;
begin
count:=0;

logs.Debuglogs('###################### DANSGUARDIAN #####################');


if not FileExists(BIN_PATH()) then begin
   logs.Debuglogs('Starting......: DansGuardian is not installed');
   exit;
end;

if DansGuardianEnabled=0 then begin
   logs.Debuglogs('Starting......: DansGuardian is disabled');
    DANSGUARDIAN_STOP();
    exit;
end;
if SYS.isoverloadedTooMuch() then begin
   logs.DebugLogs('Starting......: DansGuardian System is overloaded');
   exit;
end;


FileTemp:=artica_path+'/ressources/logs/dansguardian.start';
if FileExists(transparent_image_path()) then logs.OutputCmd('/bin/ln -s --force '+transparent_image_path()+' /etc/dansguardian/transparent1x1.gif');



forcedirectories('/var/log/dansguardian');
logs.OutputCmd('/bin/chown -R '+username+':'+username+' /var/log/dansguardian');
C_ICAP_START();
pid:=DANSGUARDIAN_PID();



  if length(pid)=0 then begin
     pid:=SYS.PIDOF(BIN_PATH());
     if length(pid)>0 then begin
         logs.DebugLogs('Starting......: DansGuardian kill all bad pids ' + pid);
         fpsystem('/bin/kill -9 ' + pid);
     end;
  end;


 logs.Debuglogs('DANSGUARDIAN_START() -> PID='+ DANSGUARDIAN_PID());
 if SYS.PROCESS_EXIST(DANSGUARDIAN_PID()) then begin
    logs.DebugLogs('Starting......: DansGuardian already running using pid ' + DANSGUARDIAN_PID()+ '...');
    exit;
 end;
 if SYS.COMMANDLINE_PARAMETERS('--verbose') then verb:=' --verbose';
 fpsystem(SYS.LOCATE_PHP5_BIN()+' /usr/share/artica-postfix/exec.dansguardian.compile.php'+verb);
 verify_content_scanners();
 VERIFY_PARENT_PROXY();
 DANSGUARDIAN_TEMPLATE();
 logs.Debuglogs('Starting......: DansGuardian width username '+username);
 logs.Debuglogs('Starting......: DansGuardian...');
 if Not FileExists('/var/log/dansguardian/dansguardian.log') then begin
    forcedirectories('/var/log/dansguardian');
    logs.OutputCmd('/bin/touch /var/log/dansguardian/dansguardian.log');
 end;
 logs.OutputCmd('/bin/chown -R '+username+':'+username+' /var/log/dansguardian');
 DANSGUARDIAN_CONFIG_VALUE_SET('daemonuser',username);
 DANSGUARDIAN_CONFIG_VALUE_SET('daemongroup',username);

 if FileExists('/tmp/.dguardianipc') then logs.DeleteFile('/tmp/.dguardianipc');
 if FileExists('/tmp/.dguardianurlipc') then logs.DeleteFile('/tmp/.dguardianurlipc');
 logs.OutputCmd('/bin/chmod 777 /tmp');

 logs.OutputCmd(BIN_PATH());
     

 while not SYS.PROCESS_EXIST(DANSGUARDIAN_PID()) do begin
        sleep(100);
        inc(count);
        if count>10 then begin
           logs.DebugLogs('Starting......: DansGuardian (failed)');
           break;
        end;
  end;

 logs.Debuglogs('Starting......: DansGuardian...');
 sleep(200);


 logs.OutputCmd(BIN_PATH());

 count:=0;
 while not SYS.PROCESS_EXIST(DANSGUARDIAN_PID()) do begin
        sleep(100);
        inc(count);
        if count>10 then begin
           logs.DebugLogs('Starting......: DansGuardian (failed)');
           if not nottroubleshoot then DANSGUARDIAN_TROUBLESHOT();
           exit;
        end;
  end;

 logs.DebugLogs('Starting......: DansGuardian started with new pid ' + DANSGUARDIAN_PID());
 DANSGUARDIAN_TAIL_START();
end;
//##############################################################################
procedure tdansguardian.DANSGUARDIAN_TROUBLESHOT();
var
   tmpstr:string;
   RegExpr     :TRegExpr;
   l:Tstringlist;
   i:integer;
begin
   tmpstr:=logs.FILE_TEMP();
   logs.DebugLogs('Starting......: DansGuardian investigate the problem...');
   fpsystem(BIN_PATH() + ' >' + tmpstr +' 2>&1');

   if not FileExists(tmpstr) then begin
        logs.DebugLogs('Starting......: DansGuardian investigate failed');
        exit;
   end;


   l:=Tstringlist.Create;
   l.LoadFromFile(tmpstr);
   logs.DeleteFile(tmpstr);
   RegExpr:=TRegExpr.Create;


   for i:=0 to l.Count-1 do begin


   RegExpr.Expression:='Error binding ipc server file.+?rm\s+(.+?)''';
   if RegExpr.Exec(l.Strings[i]) then begin
       logs.DebugLogs('Starting......: DansGuardian found ipc server error on '+RegExpr.Match[1] +' file');
       if FileExists(RegExpr.Match[1]) then logs.DeleteFile(RegExpr.Match[1]);
       DANSGUARDIAN_START(true);
       break;
   end;


   RegExpr.Expression:='Unable.+?plugin.+?clamdscan';
     if RegExpr.Exec(l.Strings[i]) then begin
         logs.DebugLogs('Starting......: DansGuardian found clamav error "'+l.Strings[i]+'" disable Clamav');
         SYS.SET_INFO('DansGuardianEnableClamav','0');
         fpsystem(SYS.LOCATE_PHP5_BIN()+' /usr/share/artica-postfix/exec.dansguardian.compile.php');
         break;
     end;

     logs.DebugLogs('Starting......: '+l.Strings[i]);

   end;

 l.free;
 RegExpr.free;

end;
//##############################################################################


procedure tdansguardian.VERIFY_PARENT_PROXY();
var
   squid:tsquid;
   http_port,tmp:string;
   RegExpr     :TRegExpr;
begin
   squid:=tsquid.Create;
   http_port:=squid.SQUID_GET_CONFIG('http_port');
   RegExpr:=TRegExpr.Create;
   RegExpr.Expression:='([0-9]+)';

   if RegExpr.Exec(http_port) then http_port:=RegExpr.Match[1];
logs.DebugLogs('Starting......: Squid configuration file:' + squid.SQUID_CONFIG_PATH());
logs.DebugLogs('Starting......: Squid listen on port : 127.0.0.1:' + http_port);

DANSGUARDIAN_CONFIG_VALUE_SET('proxyport',http_port);
DANSGUARDIAN_CONFIG_VALUE_SET('proxyip','127.0.0.1');
DANSGUARDIAN_CONFIG_VALUE_SET('originalip','off');
end;
//##############################################################################
procedure tdansguardian.C_ICAP_RELOAD();
var
   pid:string;
begin
   if CicapEnabled=0 then begin
     logs.Debuglogs('Starting......: c-icap is disabled by artica by "CicapEnabled" token...');
     C_ICAP_STOP();
     exit;
   end;

   PID:= C_ICAP_PID();
   if not SYS.PROCESS_EXIST(pid) then begin
        C_ICAP_START();
        exit;
   end;

   logs.Debuglogs('Starting......: reloading c-icap pid '+PID);
   logs.OutputCmd('/bin/kill -HUP ' + PID);
end;
//##############################################################################

procedure tdansguardian.C_ICAP_START();
var
   count:integer;
   pid:string;


begin
count:=0;
if not FileExists(C_ICAP_BIN_PATH()) then begin
   logs.Debuglogs('C_ICAP_START():: unable to stat c-icap bin...');
   exit;
end;

if not FileExists(clamav.CLAMSCAN_BIN_PATH()) then begin
      logs.Debuglogs('Starting......: c-icap Unable to stat clamscan bin path, aborting...');
      exit;
end;

if CicapEnabled=0 then begin
     logs.Debuglogs('Starting......: c-icap is disabled by artica by "CicapEnabled" token...');
     C_ICAP_STOP();
     exit;
end;


PID:= C_ICAP_PID();



 logs.Debuglogs('C_ICAP_START() -> PID='+ PID);
 if SYS.PROCESS_EXIST(PID) then begin
    logs.Debuglogs('Starting......: c-icap already running using pid ' + PID+ '...');
    exit;
 end;
  C_ICAP_CONFIGURE();
 logs.Debuglogs('Starting......: c-icap...');
 logs.Debuglogs(C_ICAP_BIN_PATH() + ' -f '+C_ICAP_CONF_PATH());
 fpsystem(C_ICAP_BIN_PATH() + ' -f '+C_ICAP_CONF_PATH()+' -d 3');

 

 while not SYS.PROCESS_EXIST(C_ICAP_PID()) do begin

        sleep(100);
        inc(count);
        if count>50 then begin
           logs.DebugLogs('Starting......: c-icap (timeout)');
           break;
        end;
  end;

 
 PID:= C_ICAP_PID();
 
 if length(PID)>0 then begin
    logs.DebugLogs('Starting......: c-icap started with new pid ' + PID);
 end else begin
    writeln('Starting......: c-icap failed');
 end;
 
end;
//##############################################################################
procedure tdansguardian.C_ICAP_CONFIGURE();
var
   user:string;
   chown:string;
   internal_conf:string;
   VirSaveDir:string;
   InternalConf:TiniFile;
begin

internal_conf:='/etc/artica-postfix/settings/Daemons/CicapInternalConfiguration';
VirSaveDir:='/opt/artica/share/www/squid-attachments';
 chown:=username+':'+username;
 logs.DebugLogs('Starting......: c-icap using user: ' + username);
 if FileExists(internal_conf) then begin
       InternalConf:=TiniFile.Create(internal_conf);
       VirSaveDir:=InternalConf.ReadString('CONF','VirSaveDir','/opt/artica/share/www/squid-attachments');
       InternalConf.Free;
 end;

ForceDirectories('/var/log/squid');
ForceDirectories('/var/log/squid');
ForceDirectories('/var/lib/c_icap/temporary');
ForceDirectories('/var/run/c-icap');
if not FIleExists('/var/log/squid/c-icap_server.log') then logs.WriteToFile('','/var/log/squid/c-icap_server.log');
if not FIleExists('/var/log/squid/c-icap_access.log') then logs.WriteToFile('','/var/log/squid/c-icap_access.log');
ForceDirectories(VirSaveDir);
logs.OutputCmd('/bin/chown -R '+chown+' /var/log/squid');
logs.OutputCmd('/bin/chown -R '+chown+' /var/run/c-icap');
logs.OutputCmd('/bin/chown -R '+chown+' /var/lib/c_icap/temporary');
logs.OutputCmd('/bin/chown -R '+chown+' '+VirSaveDir);
logs.OutputCmd('/bin/chmod -R 775 '+VirSaveDir);

if FileExists('/etc/artica-postfix/settings/Daemons/CicapMainConfiguration') then begin
   logs.OutputCmd('/bin/cp -f /etc/artica-postfix/settings/Daemons/CicapMainConfiguration ' + C_ICAP_CONF_PATH());
end;





   C_ICAP_VALUE_SET('ServerLog','/var/log/squid/c-icap_server.log');
   C_ICAP_VALUE_SET('AccessLog','/var/log/squid/c-icap_access.log');
   C_ICAP_VALUE_SET('User',username);
   C_ICAP_VALUE_SET('Group',username);
   C_ICAP_VALUE_SET('Port','1351');
   C_ICAP_VALUE_SET('PidFile','/var/run/c-icap/c-icap.pid');
   C_ICAP_VALUE_SET('CommandsSocket','/var/run/c-icap/c-icap.ctl');
   C_ICAP_VALUE_SET('TmpDir','/var/lib/c_icap/temporary');
   C_ICAP_VALUE_SET('ServicesDir','/usr/lib/c_icap');
   C_ICAP_VALUE_SET('Service','echo_module srv_echo.so');
   C_ICAP_VALUE_SET('Service','url_check_module srv_url_check.so');
   C_ICAP_VALUE_SET('Service','antivirus_module srv_clamav.so');
   C_ICAP_VALUE_SET('ModulesDir' ,'/usr/lib/c_icap');
   C_ICAP_VALUE_SET('Module logger','sys_logger.so');
   C_ICAP_VALUE_SET('ServiceAlias','avscan srv_clamav?allow204=on&sizelimit=off&mode=simple');
   C_ICAP_VALUE_SET('srv_clamav.ClamAvTmpDir','/tmp');








end;
//##############################################################################
procedure tdansguardian.DANSGUARDIAN_STOP();
 var
    pid:string;
    count:integer;
begin
count:=0;
  if not FileExists(BIN_pATH) then begin
     writeln('Stopping DansGuardian........: Not installed');
     exit;
  end;
  pid:=DANSGUARDIAN_PID();

   if not SYS.PROCESS_EXIST(pid) then begin
      writeln('Stopping DansGuardian........: Already stopped');
      DANSGUARDIAN_TAIL_STOP();
      exit;
   end;

  if SYS.PROCESS_EXIST(pid) then begin
  writeln('Stopping DansGuardian........: ' + pid + ' PID');
  logs.OutputCmd('/bin/kill '+pid);
  logs.OutputCmd(BIN_pATH()+' -q');
  pid:=trim(DANSGUARDIAN_PID());
  if length(trim(pid))=0 then begin
      writeln('Stopping DansGuardian........: Stopped success');
       if FileExists('/tmp/.dguardianipc') then logs.DeleteFile('/tmp/.dguardianipc');
       if FileExists('/tmp/.dguardianurlipc') then logs.DeleteFile('/tmp/.dguardianurlipc');
       exit;
  end;


       while SYS.PROCESS_EXIST(pid) do begin
        sleep(100);
        inc(count);
        if length(trim(pid))=0 then break;
        logs.OutputCmd('/bin/kill '+pid);
        logs.OutputCmd(BIN_pATH()+' -q');
        dansguardian_mem_pid:='';
        if count>30 then break;
        pid:=trim(DANSGUARDIAN_PID());
       end;
  end;

  if not SYS.PROCESS_EXIST(DANSGUARDIAN_PID()) then begin
     writeln('Stopping DansGuardian........: Stopped success');
     if FileExists('/tmp/.dguardianipc') then logs.DeleteFile('/tmp/.dguardianipc');
     if FileExists('/tmp/.dguardianurlipc') then logs.DeleteFile('/tmp/.dguardianurlipc');
  end;

  DANSGUARDIAN_TAIL_STOP();

end;
//##############################################################################

procedure tdansguardian.C_ICAP_STOP();
 var
    pid:string;
    allpids:string;
    count:integer;
begin
count:=0;
  if not FileExists(C_ICAP_BIN_PATH()) then begin
     writeln('Stopping C-icap..............: Not installed');
     exit;
  end;
  
  pid:=C_ICAP_PID();
  if not SYS.PROCESS_EXIST(pid) then begin
     PID:=SYS.PidByProcessPath(C_ICAP_BIN_PATH());
  end;
  
if SYS.PROCESS_EXIST(pid) then begin
   writeln('Stopping C-icap..............: ' + pid + ' PID');
   logs.OutputCmd('/bin/kill '+ pid);

  while SYS.PROCESS_EXIST(pid) do begin
        sleep(100);
        inc(count);
        if count>30 then break;
  end;
  end;

  allpids:=SYS.PidAllByProcessPath(C_ICAP_BIN_PATH());
  if length(allpids)>0 then begin
     writeln('Stopping C-icap..............: ' + allpids + ' PIDs');
     fpsystem('/bin/kill -9 '+ allpids);
  end;

  cicap_mem_pid:='';
  if not SYS.PROCESS_EXIST(C_ICAP_PID()) then begin
     writeln('Stopping C-icap..............: Stopped');
  end else begin
     writeln('Stopping C-icap..............: Failed');
  end;
end;
//##############################################################################

function tdansguardian.DANSGUARDIAN_STATUS():string;
var
ini:TstringList;
begin
if not FileExists(BIN_PATH()) then exit;

   ini:=TstringList.Create;
   ini.Add('[DANSGUARDIAN]');
   ini.Add('service_name=APP_DANSGUARDIAN');
   ini.Add('service_cmd=dansgardian');
   ini.Add('remove_cmd=--dansguardian-remove');
   ini.Add('master_version=' + DANSGUARDIAN_VERSION());


   if SQUIDEnable=0 then begin
      ini.Add('service_disabled=0');
      result:=ini.Text;
      SYS.MONIT_DELETE('APP_DANSGUARDIAN');
      exit;
   end;

   if DansGuardianEnabled=0 then begin
      ini.Add('service_disabled=0');
      result:=ini.Text;
      SYS.MONIT_DELETE('APP_DANSGUARDIAN');
      exit;
   end;


   if SYS.MONIT_CONFIG('APP_DANSGUARDIAN','/var/run/dansguardian.pid','dansgardian') then begin
   ini.Add('monit=1');
   result:=ini.Text;
   ini.free;
   exit;
   end;



      if SYS.PROCESS_EXIST(DANSGUARDIAN_PID()) then ini.Add('running=1') else  ini.Add('running=0');
      ini.Add('dansguardian_installed=1');
      ini.Add('application_installed=1');
      ini.Add('master_pid='+ DANSGUARDIAN_PID());
      ini.Add('master_memory=' + IntToStr(SYS.PROCESS_MEMORY(DANSGUARDIAN_PID())));
      ini.Add('status='+SYS.PROCESS_STATUS(DANSGUARDIAN_PID()));
      ini.Add('service_disabled='+ IntToStr(DansGuardianEnabled));



   result:=ini.Text;
   ini.free;

end;
//##############################################################################
function tdansguardian.C_ICAP_VERSION():string;
var
    RegExpr:TRegExpr;
    FileDatas:TStringList;
    i:integer;
    BinPath:string;
    filetmp:string;
    nocache:boolean;
begin
if not FIleExists('/usr/bin/c-icap-config') then result:='060708rc2';
if not nocache then begin
   result:=SYS.GET_CACHE_VERSION('APP_C_ICAP');
   if length(result)>2 then exit;
end;
filetmp:=logs.FILE_TEMP();
if not FileExists('/usr/bin/c-icap-config') then begin
   logs.Debuglogs('unable to find /usr/bin/c-icap-config');
   exit;
end;

logs.Debuglogs('/usr/bin/c-icap-config --version >'+filetmp+' 2>&1');
fpsystem('/usr/bin/c-icap-config --version >'+filetmp+' 2>&1');
result:=trim(logs.ReadFromFile(filetmp));
logs.DeleteFile(filetmp);
SYS.SET_CACHE_VERSION('APP_C_ICAP',result);
end;


//##############################################################################
function tdansguardian.C_ICAP_STATUS():string;
var
ini:TstringList;
pid:string;
pidpath:string;
begin
if not FileExists(C_ICAP_BIN_PATH()) then exit;
pidpath:='/var/run/c-icap/c-icap.pid';
ini:=TstringList.Create;
ini.Add('[C-ICAP]');
ini.Add('master_version='+C_ICAP_VERSION());
ini.Add('service_name=APP_C_ICAP');
ini.Add('service_cmd=cicap');


   if SQUIDEnable=0 then begin
      ini.Add('service_disabled=0');
      result:=ini.Text;
      SYS.MONIT_DELETE('APP_C_ICAP');
      exit;
   end;

   if CicapEnabled=0 then begin
      ini.Add('service_disabled=0');
      result:=ini.Text;
      SYS.MONIT_DELETE('APP_C_ICAP');
      exit;
   end;


   if SYS.MONIT_CONFIG('APP_C_ICAP',pidpath,'cicap') then begin
   ini.Add('monit=1');
   result:=ini.Text;
   ini.free;
   exit;
   end;



      pid:=C_ICAP_PID();
      if SYS.PROCESS_EXIST(pid) then ini.Add('running=1') else  ini.Add('running=0');
      ini.Add('application_installed=1');
      ini.Add('master_pid='+ pid);
      ini.Add('master_memory=' + IntToStr(SYS.PROCESS_MEMORY(pid)));
      ini.Add('status='+SYS.PROCESS_STATUS(pid));
      ini.Add('service_disabled='+ IntToStr(CicapEnabled));
      result:=ini.Text;
      ini.free;

end;
//##############################################################################
function tdansguardian.DANSGUARDIAN_STATS():string;
var
   tmpstr:string;
   phpfile:string;
begin
if not FileExists(BIN_PATH) then exit;
phpfile:=artica_path+'/cron.dansguardian.php';
if not FileExists(phpfile) then begin
   writeln('Unable to stat ' +phpfile);
   logs.Syslogs('Unable to stat '+phpfile);
   exit;
end;

DANSGUARDIAN_STOP();
logs.OutputCmd('/bin/mv /var/log/dansguardian/access.log /var/log/dansguardian/access_work.log');
logs.OutputCmd('/bin/touch /var/log/dansguardian/access.log');
logs.OutputCmd('/bin/chown '+username+':'+username+' /var/log/dansguardian/access.log');
DANSGUARDIAN_START();
writeln('');
logs.OutputCmd(SYS.EXEC_NICE()+SYS.LOCATE_PHP5_BIN() + ' ' +phpfile+ ' /var/log/dansguardian/access_work.log &');
writeln('');
end;
//##############################################################################
function tdansguardian.DANSGUARDIAN_TAIL_PID():string;
var
   pid:string;
begin

if FileExists('/etc/artica-postfix/exec.dansguardian-tail.php.pid') then begin
   pid:=SYS.GET_PID_FROM_PATH('/etc/artica-postfix/exec.dansguardian-tail.php.pid');
   logs.Debuglogs('DANSGUARDIAN_TAIL_PID /etc/artica-postfix/exec.dansguardian-tail.php.pid='+pid);
   if SYS.PROCESS_EXIST(pid) then result:=pid;
   exit;
end;


result:=SYS.PIDOF_PATTERN(TAIL_STARTUP);
logs.Debuglogs(TAIL_STARTUP+' pid='+pid);
end;
//#####################################################################################


procedure tdansguardian.DANSGUARDIAN_TAIL_START();
var
   pid:string;
   pidint:integer;
   log_path:string;
   count:integer;
   cmd:string;
   CountTail:Tstringlist;
begin

if not FileExists(BIN_PATH()) then begin
   logs.Debuglogs('Starting......: artica-dansguardian realtime logs:: DansGuardian is not installed');
   exit;
end;


if DansGuardianEnabled=0 then begin
    logs.Debuglogs('Starting......: artica-dansguardian realtime logs:: DansGuardian is disabled');
    DANSGUARDIAN_TAIL_STOP();
    exit;
end;

pid:=DANSGUARDIAN_TAIL_PID();
if SYS.PROCESS_EXIST(pid) then begin
      logs.DebugLogs('Starting......: artica-dansguardian realtime logs already running with pid '+pid);
      if DansGuardianEnabled=0 then DANSGUARDIAN_TAIL_STOP();
      CountTail:=Tstringlist.Create;
      CountTail.AddStrings(SYS.PIDOF_PATTERN_PROCESS_LIST('/usr/bin/tail -f -n 0 /var/log/dansguardian/access.log'));
      logs.DebugLogs('Starting......: artica-dansguardian realtime process number:'+IntToStr(CountTail.Count));
      if CountTail.Count>3 then fpsystem('/etc/init.d/artica-postfix restart dansguardian-tail');
      CountTail.free;
      exit;
end;
log_path:='/var/log/dansguardian/access.log';

if not FileExists(log_path) then begin
   logs.DebugLogs('Starting......: artica-dansguardian realtime stats, unable to stats logfile');
   exit;
end;
DANSGUARDIAN_TAIL_STOP();
logs.DebugLogs('Starting......: artica-dansguardian realtime logs path: '+log_path);

pid:=SYS.PIDOF_PATTERN('/usr/bin/tail -f -n 0 /var/log/dansguardian/access.log');
count:=0;
pidint:=0;
      while SYS.PROCESS_EXIST(pid) do begin
          if count>0 then break;
          if not TryStrToInt(pid,pidint) then continue;
          logs.DebugLogs('Starting......: artica-dansguardian realtime logs stop tail pid '+pid);
          if pidint>0 then  fpsystem('/bin/kill '+pid);
          sleep(200);
          pid:=SYS.PIDOF_PATTERN('/usr/bin/tail -f -n 0 /var/log/dansguardian/access.log');
          inc(count);
      end;

cmd:='/usr/bin/tail -f -n 0 '+log_path+'|'+TAIL_STARTUP+' >>/var/log/artica-postfix/dansguardian-logger-start.log 2>&1 &';
logs.Debuglogs(cmd);
fpsystem(cmd);
pid:=DANSGUARDIAN_TAIL_PID();
count:=0;
while not SYS.PROCESS_EXIST(pid) do begin
        sleep(100);
        inc(count);
        if count>40 then begin
           logs.DebugLogs('Starting......: artica-dansguardian realtime logs (timeout)');
           break;
        end;
        pid:=DANSGUARDIAN_TAIL_PID();
  end;

pid:=DANSGUARDIAN_TAIL_PID();

if SYS.PROCESS_EXIST(pid) then begin
      logs.DebugLogs('Starting......: artica-dansguardian realtime logs success with pid '+pid);
      exit;
end else begin
    logs.DebugLogs('Starting......: artica-dansguardian realtime logs failed');
end;
end;
//#####################################################################################
function tdansguardian.DANSGUARDIAN_TAIL_STATUS():string;
var
ini:TstringList;
pid:string;
Enabled:integer;
begin

if not FileExists(BIN_PATH()) then begin
 SYS.MONIT_DELETE('APP_ARTICA_DANSGUARDIAN_TAIL');
 exit;
end;


   if DansGuardianEnabled=0 then begin
      SYS.MONIT_DELETE('APP_ARTICA_DANSGUARDIAN_TAIL');
       exit;
   end;

    ini:=TstringList.Create;
    ini.Add('[ARTICA_DANS_TAIL]');
    ini.Add('service_name=APP_ARTICA_DANSGUARDIAN_TAIL');
    ini.Add('service_cmd=dansguardian-tail');
    ini.Add('service_disabled='+ IntToStr(DansGuardianEnabled));
    ini.Add('master_version=' + SYS.ReadFileIntoString(artica_path+'/VERSION'));

     if SYS.MONIT_CONFIG('APP_ARTICA_DANSGUARDIAN_TAIL','/etc/artica-postfix/exec.dansguardian-tail.php.pid','dansguardian-tail') then begin
       ini.Add('monit=1');
        result:=ini.Text;
        ini.free;
        exit;
     end;

   pid:=DANSGUARDIAN_TAIL_PID();

      if SYS.PROCESS_EXIST(pid) then ini.Add('running=1') else  ini.Add('running=0');
      ini.Add('application_installed=1');
      ini.Add('master_pid='+ pid);
      ini.Add('master_memory=' + IntToStr(SYS.PROCESS_MEMORY(pid)));
      ini.Add('status='+SYS.PROCESS_STATUS(pid));


   result:=ini.Text;
   ini.free;
end;
//#####################################################################################
procedure tdansguardian.DANSGUARDIAN_TAIL_STOP();
var
   pid:string;
   pidint,i:integer;
   count:integer;
   CountTail:Tstringlist;
begin
pid:=DANSGUARDIAN_TAIL_PID();
if not SYS.PROCESS_EXIST(pid) then begin
      writeln('Stopping DansGuardian RealTime log: Already stopped');
      CountTail:=Tstringlist.Create;
      try
         CountTail.AddStrings(SYS.PIDOF_PATTERN_PROCESS_LIST('/usr/bin/tail -f -n 0 /var/log/dansguardian/access.log'));
         writeln('Stopping DansGuardian RealTime log: Tail processe(s) number '+IntToStr(CountTail.Count));
      except
        logs.Debuglogs('Stopping DansGuardian RealTime log: fatal error on SYS.PIDOF_PATTERN_PROCESS_LIST() function');
      end;

      count:=0;
     for i:=0 to CountTail.Count-1 do begin;
          pid:=CountTail.Strings[i];
          if count>100 then break;
          if not TryStrToInt(pid,pidint) then continue;
          writeln('Stopping DansGuardian RealTime log: Stop tail pid '+pid);
          if pidint>0 then  fpsystem('/bin/kill '+pid);
          sleep(100);
          inc(count);
      end;
      exit;
end;

writeln('Stopping DansGuardian RealTime log: Stopping pid '+pid);
fpsystem('/bin/kill '+pid);

pid:=DANSGUARDIAN_TAIL_PID();
if not SYS.PROCESS_EXIST(pid) then begin
      writeln('Stopping DansGuardian RealTime log: Stopped');
end;


CountTail:=Tstringlist.Create;
CountTail.AddStrings(SYS.PIDOF_PATTERN_PROCESS_LIST('/usr/bin/tail -f -n 0 /var/log/dansguardian/access.log'));
writeln('Stopping DansGuardian RealTime log: Tail processe(s) number '+IntToStr(CountTail.Count));
count:=0;
     for i:=0 to CountTail.Count-1 do begin;
          pid:=CountTail.Strings[i];
          if count>100 then break;
          if not TryStrToInt(pid,pidint) then continue;
          writeln('Stopping DansGuardian RealTime log: Stop tail pid '+pid);
          if pidint>0 then  fpsystem('/bin/kill '+pid);
          sleep(100);
          inc(count);
      end;


end;
//#####################################################################################


function tdansguardian.DANSGUARDIAN_CONFIG_VALUE(key:string):string;
var
   l           :TstringList;
   RegExpr     :TRegExpr;
   i           :integer;
begin

    if not FileExists(CONF_PATH()) then exit;
    RegExpr:=TRegExpr.Create;
    l:=TstringList.create;

    RegExpr.Expression:='^'+key+'[\s=]+(.*)';
    l.LoadFromFile(CONF_PATH());
    For i:=0 to l.Count-1 do begin
        if RegExpr.Exec(l.Strings[i]) then begin
               result:=trim(RegExpr.Match[1]);
               result:=trim(result);
         end;

    end;
    
    
    result:=AnsiReplaceText(result,'''','');
    RegExpr.free;
    l.free;

end;
 //#############################################################################
function tdansguardian.DANSGUARDIAN_DELETE_VALUE(key:string):string;
var
   l           :TstringList;
   RegExpr     :TRegExpr;
   i           :integer;
begin
    result:='';
    if not FileExists(CONF_PATH()) then exit;
    RegExpr:=TRegExpr.Create;
    l:=TstringList.create;

    RegExpr.Expression:='^'+key+'[\s=]+(.*)';
    l.LoadFromFile(CONF_PATH());
    For i:=0 to l.Count-1 do begin
        if RegExpr.Exec(l.Strings[i]) then begin
               l.Delete(i);
               logs.DebugLogs('Starting......: Dansguardian delete key ' + key + ' line ' + IntToStr(i));
               l.SaveToFile(CONF_PATH());
               break;
         end;

    end;

    RegExpr.free;
    l.free;

end;
 //#############################################################################

 //#############################################################################
function tdansguardian.GET_VALUE_DATA(conf_path:string;key:string):string;
var
   l           :TstringList;
   RegExpr     :TRegExpr;
   i           :integer;
   tmpstr:string;
begin
   if not FileExists(conf_path) then begin
      logs.Debuglogs('tdansguardian.GET_VALUE_DATA: unable to stat "'+conf_path+'"');
      exit;
   end;

   l:=TstringList.Create;
   l.LoadFromFile(conf_path);
   RegExpr:=TRegExpr.Create;
   RegExpr.Expression:='^'+key+'(.+)';
   for i:=0 to l.Count-1 do begin
       if RegExpr.Exec(l.Strings[i]) then begin
          tmpstr:=RegExpr.Match[1];
          tmpstr:=AnsiReplaceText(tmpstr,'''','');
          tmpstr:=AnsiReplaceText(tmpstr,'=','');
          result:=trim(tmpstr);
          break;
       end;
   end;

   l.free;
   RegExpr.free;


end;
 //#############################################################################

procedure tdansguardian.DANSGUARDIAN_TEMPLATE();
var
DansGuardianHTMLTemplate:string;
l:TstringList;
i:integer;
begin

DansGuardianHTMLTemplate:=SYS.GET_INFO('DansGuardianHTMLTemplate');
if length(DansGuardianHTMLTemplate)<10 then begin
   if FileExists('/usr/share/artica-postfix/bin/install/dansguardian/template.html') then begin
      logs.DebugLogs('Starting......: Dansguardian installing new template file..');
      SYS.set_INFO('DansGuardianHTMLTemplate',logs.ReadFromFile('/usr/share/artica-postfix/bin/install/dansguardian/template.html'));
      DansGuardianHTMLTemplate:=SYS.GET_INFO('DansGuardianHTMLTemplate');
   end;

end;


DansGuardianHTMLTemplate:=SYS.GET_INFO('DansGuardianHTMLTemplate');
l:=TstringList.Create;
l.Add('/etc/dansguardian/languages/ukenglish/template.html');
l.add('/etc/dansguardian/languageslithuanian/template.html');
l.add('/etc/dansguardian/languagesptbrazilian/template.html');
l.add('/etc/dansguardian/languagesslovak/template.html');
l.add('/etc/dansguardian/languagesitalian/template.html');
l.add('/etc/dansguardian/languagesmalay/template.html');
l.add('/etc/dansguardian/languagesportuguese/template.html');
l.add('/etc/dansguardian/languageshebrew/template.html');
l.add('/etc/dansguardian/languagesrussian-koi8-r/template.html');
l.add('/etc/dansguardian/languagesfrench/template.html');
l.add('/etc/dansguardian/languagesdanish/template.html');
l.add('/etc/dansguardian/languageschinesegb2312/template.html');
l.add('/etc/dansguardian/languagesjapanese/template.html');
l.add('/etc/dansguardian/languagesukenglish/template.html');
l.add('/etc/dansguardian/languagesturkish/template.html');
l.add('/etc/dansguardian/languagesmxspanish/template.html');
l.add('/etc/dansguardian/languagespolish/template.html');
l.add('/etc/dansguardian/languagesspanish/template.html');
l.add('/etc/dansguardian/languagesswedish/template.html');
l.add('/etc/dansguardian/languageshungarian/template.html');
l.add('/etc/dansguardian/languagesarspanish/template.html');
l.add('/etc/dansguardian/languagesbulgarian/template.html');
l.add('/etc/dansguardian/languagesindonesian/template.html');
l.add('/etc/dansguardian/languageschinesebig5/template.html');
l.add('/etc/dansguardian/languagesgerman/template.html');
l.add('/etc/dansguardian/languagesczech/template.html');
l.add('/etc/dansguardian/languagesdutch/template.html');
l.add('/etc/dansguardian/languagesrussian-1251/template.html');
      logs.DebugLogs('Starting......: Dansguardian installing template file in all language');
for i:=0 to l.Count-1 do begin
    if FileExists(l.Strings[i]) then logs.WriteToFile(DansGuardianHTMLTemplate,l.Strings[i]);
end;
    l.free;


end;
//##############################################################################
function tdansguardian.CheckUserButton():boolean;
var
   l:TstringList;
   RegExpr     :TRegExpr;
   i:integer;
   DansGuardianEnableUserArticaIP:string;
   script:string;
begin
result:=false;
DansGuardianEnableUserArticaIP:=trim(SYS.GET_INFO('DansGuardianEnableUserArticaIP'));

if not FileExists('/etc/artica-postfix/settings/Daemons/DansGuardianHTMLTemplate') then exit();

script:='<script>';
script:=script+'function ljs(){';
script:=script+'var myhostname="'+DansGuardianEnableUserArticaIP+'";';
script:=script+'var myport="";var myurl="-URL-";';
script:=script+'var myreason="-REASONLOGGED-";var hostname=location.hostname;';
script:=script+'if(myhostname.length==0){myhostname=hostname;}if(myport.length==0){myport="9000";}';
script:=script+'var src="https://"+myhostname+":"+myport+"/dansguardian.users.index.php?uri="+myurl+"&myreason="+myreason;';
script:=script+'document.location.href=src;';
script:=script+'}';
script:=script+'</script><tr><td colspan=2 align="center"><input type="button" OnClick="javascript:ljs();" value="Continue..."></td></tr>';



   l:=TstringList.Create;
   l.LoadFromFile('/etc/artica-postfix/settings/Daemons/DansGuardianHTMLTemplate');
   RegExpr:=TRegExpr.Create;
   RegExpr.Expression:='USER_BUTTON';
   for i:=0 to l.Count-1 do begin
      if RegExpr.Exec(l.Strings[i]) then begin
         logs.DebugLogs('Starting......: Dansguardian Enable release banned site: ' + IntToStr(DansGuardianEnableUserFrontEnd));
         if DansGuardianEnableUserFrontEnd=1 then l.Strings[i]:='<!-- USER_BUTTON -->'+ script else l.Strings[i]:='<!-- USER_BUTTON -->';
         result:=true;
         break;
      end;
   end;
   l.SaveToFile('/etc/artica-postfix/settings/Daemons/DansGuardianHTMLTemplate');
   RegExpr.free;
   l.free;
end;
//#############################################################################
procedure tdansguardian.DANSGUARDIAN_CONFIG_VALUE_SET(key:string;value:string);
var
   l           :TstringList;
   RegExpr     :TRegExpr;
   i           :integer;
   found       :boolean;
begin
    found:=false;
    if not FileExists(CONF_PATH()) then exit;
    RegExpr:=TRegExpr.Create;
    l:=TstringList.create;

    RegExpr.Expression:='^'+Lowercase(key)+'[\s=]+(.*)';
    l.LoadFromFile(CONF_PATH());
    For i:=0 to l.Count-1 do begin
      if RegExpr.Exec(Lowercase(l.Strings[i])) then begin
              found:=true;
              l.Strings[i]:=key + ' = ' + value;
              break;
         end;

    end;

    if not found then begin
        logs.DebugLogs('Starting......: Dansguardian adding setting '+ key + ' "' + value+'"');
        l.Add(key + ' = ' + value);
    end;

    logs.WriteToFile(l.Text,CONF_PATH());
    RegExpr.free;
    l.free;

end;


//#############################################################################
 procedure tdansguardian.C_ICAP_VALUE_SET(key:string;value:string);
var
   l           :TstringList;
   RegExpr     :TRegExpr;
   i           :integer;
   found       :boolean;
   keyF        :string;
   D           :boolean;
begin
    found:=false;
    if not FileExists(C_ICAP_CONF_PATH()) then begin
       logs.Debuglogs('C_ICAP_VALUE_SET:: unable to stat c-icap.conf');
       exit;
    end;
    RegExpr:=TRegExpr.Create;
    l:=TstringList.create;
    keyF:=key;
    keyF:=AnsiReplaceText(keyF,'.','\.');
    D:=SYS.COMMANDLINE_PARAMETERS('debug');
    RegExpr.Expression:='^'+keyF+'\s+(.*)';
    l.LoadFromFile(C_ICAP_CONF_PATH());
    For i:=0 to l.Count-1 do begin
      if RegExpr.Exec(l.Strings[i]) then begin
              found:=true;
              logs.Debuglogs('C_ICAP_VALUE_SET:: (modify) '+key + ' ' + value);
              l.Strings[i]:=key + ' ' + value;
              break;
         end else begin


         end;

    end;

    if not found then begin
        logs.Debuglogs('C_ICAP_VALUE_SET:: (Add) '+key + ' ' + value);
        l.Add(key + ' ' + value);
    end;

    l.SaveToFile(C_ICAP_CONF_PATH());
    RegExpr.free;
    l.free;

end;


//#############################################################################
function tdansguardian.DANSGUARDIAN_BIN_VERSION(version:string):int64;
var
   tmp            :string;
   tmp2           :string;
   RegExpr        :TRegExpr;
   t              :integer;
   i              :int64;
begin
   result:=0;
   RegExpr:=TRegExpr.Create;
   tmp2:=trim(AnsiReplaceText(version,'-',''));
   tmp2:=trim(AnsiReplaceText(version,'.',''));
   if length(tmp2)=3 then tmp2:=tmp2+'0';
   if length(tmp2)=2 then tmp2:=tmp2+'00';
   if not TryStrToInt64(tmp2,result) then writeln('int64 failed');
end;
//#############################################################################
end.
